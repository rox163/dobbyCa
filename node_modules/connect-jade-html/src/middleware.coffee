jade = require 'jade'
fs = require 'fs'
path = require 'path'
url = require 'url'
mkdirp = require 'mkdirp'
debug = require('debug')('connect-jade');

clone = (src) ->
  return unless typeof src is 'object'
  return src.slice() if Array.isArray src
  obj = {}
  for prop, val of src then obj[prop] = val
  obj

###

A simple connect middleware to serve CoffeeScript files.

@param {Object} options
@return {Function}
@api public
###

module.exports = (options = {}) ->

  # Accept src/dest dir
  if typeof options is 'string'
    options = src: options

  # Base directory
  baseDir = options.baseDir or process.cwd()

  # Source dir required
  src = options.src
  throw new Error 'Coffeescript middleware requires "src" directory' unless src
  src = path.resolve baseDir, src

  # Default dest dir to source
  dest = if options.dest then options.dest else src
  dest = path.resolve baseDir, dest

  # Default compile callback
  options.compile ?= (str, options) ->
    tmpl = jade.compile str, clone(options)
    return tmpl().replace(/^\s+|\s+$/g, '')

  # Middleware
  (req, res, next) ->
    return next() if 'GET' isnt req.method and 'HEAD' isnt req.method
    pathname = url.parse(req.url).pathname
    if /\.html$/.test pathname
      if options.prefix and 0 is pathname.indexOf options.prefix
        pathname = pathname.substring options.prefix.length
      htmlPath = path.join dest, pathname
      jadePath = path.join src, pathname.replace '.html', '.jade'

      # Ignore ENOENT to fall through as 404
      error = (err) ->
        arg = if 'ENOENT' is err.code then null else err
        next arg

      # Compile to htmlPath
      compile = ->
        debug 'read %s', htmlPath
        fs.readFile jadePath, 'utf8', (err, str) ->
          return error err if err
          # If `options` is passed to `coffeeScript.compile` (as it is in the
          # default `options.compile` function), `coffeeScript.compile` will
          # put `options.filename` in error messages. Set `options.filename`!
          options.filename = jadePath
          try
            html = options.compile str, options
          catch err
            return next err
          debug('render %s', jadePath);
          mkdirp path.dirname(htmlPath), 0o0700, (err) ->
            return error err if err
            fs.writeFile htmlPath, html, 'utf8', next

      # Force compilation
      return compile() if options.force

      # Compare mtimes
      fs.stat jadePath, (err, jadeStats) ->
        return error err if err
        fs.stat htmlPath, (err, htmlStats) ->
          # JS has not been compiled, compile it!
          if err
            if 'ENOENT' is err.code
              debug 'not found %s', htmlPath
              compile()
            else
              next err
          else
            # Source has changed, compile it
            if jadeStats.mtime > htmlStats.mtime
              debug('modified %s', htmlPath)
              compile()
            else
              next()
    else
      next()
